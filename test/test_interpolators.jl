## Data
x = [1, 2, 3, 3.1, 5.1, 6, 7, 8]
y = [1.8, 1.9, 1.7, 1.1, 1.1, 1.7, 1.4, 1.9]
## Results
s =  diff(y) ./ diff(x)

################################################################################
# LINEAR SPLINE
################################################################################

lsc = calibrate(x, y, LinearSpline())
true_coefficients = hcat(y[1:(end-1)], s)
## Test calibration
@test lsc.x == lsc.x
@test lsc.y == lsc.y
@test_approx_eq lsc.coefficients true_coefficients
## Test interpolation
## At a node
@test_approx_eq interpolate(2, lsc) 1.9
## At first / last node
@test_approx_eq interpolate(1, lsc) 1.8
@test_approx_eq interpolate(8, lsc) 1.9
## Before first / after last node
@test_throws ArgumentError interpolate(0, lsc)
@test_throws ArgumentError interpolate(9, lsc)
## Between nodes
y_12 = lsc.coefficients[1, 1] + lsc.coefficients[1, 2] * (1.2 - 1)
@test_approx_eq interpolate(1.2, lsc) y_12
## Test method without calibration
@test_approx_eq interpolate(1.2, x, y, LinearSpline()) y_12

################################################################################
# NAUTRAL CUBIC SPLINE
################################################################################
## Test case drawn from results of R applied to x, y above.
# R 3.1.2
# x = c(1, 2, 3, 3.1, 5.1, 6, 7, 8)
# y = c(1.8, 1.9, 1.7, 1.1, 1.1, 1.7, 1.4, 1.90)
# ncs = splinefun(x, y, method = 'natural')
# paste(ncs(seq(1, 8, .1)), collapse=", ")
ncs = calibrate(x, y, NaturalCubicSpline())
x0 = 1:.1:8
y0 = [1.8, 1.74259024277759, 1.68926592538685, 1.64411248765942, 1.61121536942698, 1.59466001052118, 1.59853185077369, 1.62691633001617, 1.68389888808027, 1.77356496479766, 1.9, 2.06290399368729, 2.24443518653289, 2.42236637937848, 2.57447037306577, 2.67851996843645, 2.71228796633221, 2.65354716759476, 2.48007037306577, 2.16963038358695, 1.7, 1.1, 0.554223603091185, 0.104634143213353, -0.255224511298153, -0.531808492107992, -0.731573930880824, -0.860976959281306, -0.926473708974096, -0.934520311623853, -0.891572898895236, -0.804087602452902, -0.67852055396151, -0.521327885085717, -0.338965727490184, -0.137890212839569, 0.0754425272014696, 0.294576360968279, 0.513055156796195, 0.724422783020558, 0.922223107976712, 1.1, 1.25262287499564, 1.38026333914833, 1.48441854621267, 1.56658564994324, 1.62826180409463, 1.67094416242141, 1.69612987867818, 1.70531610661951, 1.7, 1.68190012821526, 1.65362072322504, 1.61798743263013, 1.57782590403131, 1.53596178502935, 1.49522072322504, 1.45842836621917, 1.42841036161252, 1.40799235700587, 1.4, 1.40653380867554, 1.42679378303249, 1.45925479355069, 1.50239171070998, 1.55467940499022, 1.61459274687123, 1.68060660683288, 1.75119585535499, 1.82483536291742, 1.9]
y1 = Float64[interpolate(xi, ncs) for xi in x0]
@test_approx_eq y1 y0
## Before first / after last node
@test_throws ArgumentError interpolate(0, ncs)
@test_throws ArgumentError interpolate(9, ncs)

################################################################################
# CLAMPED CUBIC SPLINE
################################################################################

# Manually calculated A, b in spreadsheet
ccs = calibrate(x, y, ClampedCubicSpline(5, 2))
A = spdiagm(([1,1,.1,2,.9,1,1], [2,4,2.2,4.2,5.8,3.8,4,2], [1,1,.1,2,.9,1,1]),
    (-1,0,1))
b = [-29.4,-1.8,-34.8,36,4,-5.8,4.8,9]
ccs0 = FinancialMarkets.calibrate_cubic_spline(x, y, A, b)
@test_approx_eq ccs.coefficients ccs0.coefficients

################################################################################
# NOT-A-KNOT CUBIC SPLINE
################################################################################

# Manually calculated A, b in spreadsheet
nakcs = calibrate(x, y, NotAKnotCubicSpline())
A = spdiagm(([zeros(5),-1.0], [1,1,.1,2,.9,1,2], [-1,4,2.2,4.2,5.8,3.8,4,-1],
    [2,1,.1,2,.9,1,1], [-1.0,zeros(5)]), (-2,-1,0,1,2))
b = [0,-1.8,-34.8,36,4,-5.8,4.8,0]
nakcs0 = FinancialMarkets.calibrate_cubic_spline(x, y, A, b)
@test_approx_eq nakcs.coefficients nakcs0.coefficients

################################################################################
# AKIMA SPLINE
################################################################################
## Test case drawn from results of R applied to x, y above.
# R 3.1.2
# x = c(1, 2, 3, 3.1, 5.1, 6, 7, 8)
# y = c(1.8, 1.9, 1.7, 1.1, 1.1, 1.7, 1.4, 1.90)
# library(akima) # v0.5.11
# aksp = aspline(x, y, seq(1, 8, .1))
# paste(aksp$y, collapse=", ")
y0 = [1.79999995231628, 1.8222827911377, 1.83967208862305, 1.8529794216156, 1.86301636695862, 1.87059426307678, 1.87652456760406, 1.88161885738373, 1.88668847084045, 1.89254510402679, 1.89999997615814, 1.90559065341949, 1.90534961223602, 1.89933109283447, 1.88758969306946, 1.87017953395844, 1.84715509414673, 1.81857049465179, 1.78448033332825, 1.74493861198425, 1.70000004768372, 1.09999990463257, 1.04144787788391, 0.989458858966827, 0.943966031074524, 0.904903054237366, 0.872203171253204, 0.845799803733826, 0.82562643289566, 0.81161642074585, 0.803703188896179, 0.801820158958435, 0.805900692939758, 0.81587827205658, 0.83168625831604, 0.853258013725281, 0.880527079105377, 0.913426756858826, 0.951890528202057, 0.995851755142212, 1.0452436208725, 1.10000002384186, 1.16369736194611, 1.23733067512512, 1.31695926189423, 1.39864349365234, 1.47844338417053, 1.55241894721985, 1.61663043498993, 1.66713738441467, 1.70000004768372, 1.70876955986023, 1.69348347187042, 1.65993165969849, 1.61390459537506, 1.56119215488434, 1.50758421421051, 1.45887112617493, 1.42084240913391, 1.39928877353668, 1.39999997615814, 1.41705656051636, 1.4408301115036, 1.47154724597931, 1.50943398475647, 1.55471694469452, 1.60762250423431, 1.668377161026, 1.73720765113831, 1.81433963775635, 1.89999997615814]
aksp = calibrate(x, y, AkimaSpline())
y1 = Float64[interpolate(xi, aksp) for xi in x0]
@test_approx_eq y1 y0
